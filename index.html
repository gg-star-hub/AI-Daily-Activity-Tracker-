<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Daily Activity Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
  <header class="p-4 bg-gray-800 text-center font-bold text-lg">AI Daily Activity Tracker</header>
  <main class="flex-1 p-4 overflow-y-auto">
    <div id="log" class="space-y-3"></div>
  </main>

  <!-- Floating Buttons -->
  <div class="fixed bottom-20 right-6 flex flex-col space-y-3">
    <button id="fabBtn" aria-label="Log Activity" class="w-14 h-14 rounded-full bg-blue-600 hover:bg-blue-700 flex items-center justify-center shadow-lg text-2xl">‚ûï</button>
    <button id="clearBtn" aria-label="Clear Logs" class="w-14 h-14 rounded-full bg-red-600 hover:bg-red-700 flex items-center justify-center shadow-lg text-2xl">üóëÔ∏è</button>
    <button id="manageBtn" aria-label="Manage Activities" class="w-14 h-14 rounded-full bg-green-600 hover:bg-green-700 flex items-center justify-center shadow-lg text-2xl">‚öôÔ∏è</button>
  </div>

  <!-- Log Modal -->
  <div id="logModal" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-80">
      <h2 class="text-lg font-bold mb-4">Log Activity</h2>
      <select id="activitySelect" class="w-full mb-3 p-2 bg-gray-700 rounded"></select>
      <label class="flex items-center space-x-2 mb-3">
        <input type="checkbox" id="aiToggle" class="form-checkbox">
        <span>Enable AI Coach</span>
      </label>
      <button id="logBtn" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded">Log</button>
    </div>
  </div>

  <!-- Manage Modal -->
  <div id="manageModal" role="dialog" aria-modal="true" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-80">
      <h2 class="text-lg font-bold mb-4">Manage Activities</h2>
      <input id="newActivityInput" type="text" placeholder="New activity" class="w-full mb-3 p-2 bg-gray-700 rounded">
      <button id="addActivityBtn" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded mb-3">Add</button>
      <div id="activityList" class="space-y-2 max-h-40 overflow-y-auto"></div>
    </div>
  </div>

  <!-- Spinner -->
  <div id="spinner" class="hidden fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center space-y-4">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400"></div>
    <div id="spinnerText">Loading‚Ä¶</div>
    <div class="w-64 bg-gray-700 rounded-full h-2">
      <div id="progressBar" class="bg-yellow-400 h-2 rounded-full w-0"></div>
    </div>
  </div>

  <footer id="versionFooter" class="p-2 text-xs text-gray-500 fixed bottom-0 left-0">Testversion 0.20</footer>

<script type="module">
const VERSION = "0.20";
document.getElementById("versionFooter").textContent = "Testversion " + VERSION;

const STORAGE_KEYS = { ACTIVITIES: "activityList", LOGS: "activityLogs" };
const DEFAULT_ACTIVITIES = ["Eat","Sleep","Work","Exercise","Study","Commute","Socialize","Relax","Shop","Cook"];
let activities = JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVITIES)) || DEFAULT_ACTIVITIES;
let logs = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOGS)) || [];

const log = document.getElementById("log");
const activitySelect = document.getElementById("activitySelect");
const logModal = document.getElementById("logModal");
const manageModal = document.getElementById("manageModal");
const newActivityInput = document.getElementById("newActivityInput");
const activityList = document.getElementById("activityList");
const spinner = document.getElementById("spinner");
const spinnerText = document.getElementById("spinnerText");
const progressBar = document.getElementById("progressBar");
const aiToggle = document.getElementById("aiToggle");
let generator = null;

function sanitize(str){return str.replace(/[<>"'&]/g,c=>({"<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#x27;","&":"&amp;"}[c]));}
function safeSetItem(key,val){try{localStorage.setItem(key,JSON.stringify(val));}catch{if(key===STORAGE_KEYS.LOGS&&logs.length>10){logs=logs.slice(-10);localStorage.setItem(key,JSON.stringify(logs));alert("‚ö†Ô∏è Storage full. Kept last 10 logs.");}else{alert("‚ö†Ô∏è Storage full. Data not saved.");}}}
function renderActivities(){activitySelect.innerHTML="";activityList.innerHTML="";activities.forEach((a,i)=>{activitySelect.innerHTML+=`<option>${sanitize(a)}</option>`;activityList.innerHTML+=`<div class="flex justify-between"><span>${sanitize(a)}</span><button onclick="deleteActivity(${i})" class="text-red-400">‚úñ</button></div>`;});}
function renderLogs(){log.innerHTML="";logs.forEach(l=>{log.innerHTML+=`<div class="p-3 bg-gray-800 rounded"><div class="font-bold">${sanitize(l.activity)} ‚Äî ${new Date(l.time).toLocaleTimeString()}</div><div class="text-yellow-400">${sanitize(l.feedback||"")}</div></div>`;});}
window.deleteActivity=i=>{activities.splice(i,1);safeSetItem(STORAGE_KEYS.ACTIVITIES,activities);renderActivities();};
renderActivities();renderLogs();

// Modal handling
document.getElementById("fabBtn").onclick=()=>{logModal.classList.remove("hidden");activitySelect.focus();};
document.getElementById("manageBtn").onclick=()=>{manageModal.classList.remove("hidden");newActivityInput.focus();};
document.getElementById("clearBtn").onclick=()=>{if(confirm("Clear all logs?")){logs=[];safeSetItem(STORAGE_KEYS.LOGS,logs);renderLogs();}};
window.onclick=e=>{if(e.target===logModal)logModal.classList.add("hidden");if(e.target===manageModal)manageModal.classList.add("hidden");};
document.addEventListener("keydown",e=>{if(e.key==="Escape"){logModal.classList.add("hidden");manageModal.classList.add("hidden");}});

// Add activity
document.getElementById("addActivityBtn").onclick=()=>{const val=sanitize(newActivityInput.value.trim());if(!val){alert("Enter activity.");return;}if(activities.includes(val)){alert("Activity exists.");return;}activities.push(val);safeSetItem(STORAGE_KEYS.ACTIVITIES,activities);renderActivities();newActivityInput.value="";};

// Rule-based fallback
function ruleFeedback(a){return `Good job logging ${a}! Keep it up.`;}
function limitSentences(txt,max=4){const s=txt.split(/(?<=[.!?])\s+/).slice(0,max);return s.join(" ");}

// AI Coach
aiToggle.onchange=async()=>{if(aiToggle.checked&&!generator){if(!navigator.onLine){alert("‚ö†Ô∏è Offline.");aiToggle.checked=false;return;}spinner.classList.remove("hidden");spinnerText.textContent="Downloading AI Coach (~66MB)...";progressBar.style.width="0%";try{const {pipeline}=await import("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0");generator=await Promise.race([pipeline("text-generation","Xenova/distilgpt2",{progress_callback:p=>{if(p.total){const pct=Math.floor((p.loaded/p.total)*100);progressBar.style.width=pct+"%";spinnerText.textContent=`Downloading‚Ä¶ ${pct}% (~66MB)`;}}}),new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),30000))]);spinnerText.textContent="‚úÖ AI Coach ready (cached)";}catch(e){console.error("AI load fail:",e);alert("‚ö†Ô∏è Failed to load AI Coach.");aiToggle.checked=false;}spinner.classList.add("hidden");}};

async function aiCoachFeedback(act){const out=await generator(act,{max_new_tokens:60});let t=out[0].generated_text;if(t.startsWith(act))t=t.slice(act.length);return limitSentences(sanitize(t.trim()));}

// Log
document.getElementById("logBtn").onclick=async()=>{const act=activitySelect.value;const time=new Date().toISOString();let feedback="";if(aiToggle.checked&&generator){spinner.classList.remove("hidden");spinnerText.textContent="ü§î AI Coach thinking‚Ä¶";try{feedback=await aiCoachFeedback(act);spinnerText.textContent="‚úÖ AI Coach replied";}catch(e){console.error("AI feedback fail:",e);feedback=ruleFeedback(act);spinnerText.textContent="‚ö†Ô∏è AI Coach failed";}spinner.classList.add("hidden");}else{feedback=ruleFeedback(act);}logs.push({activity:act,time,feedback});safeSetItem(STORAGE_KEYS.LOGS,logs);renderLogs();logModal.classList.add("hidden");};
</script>
</body>
</html>
