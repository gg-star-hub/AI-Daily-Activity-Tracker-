
<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Daily Activity Planner</title>

  <!-- Tailwind CSS CDN (pinned) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN (pinned) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.min.js"></script>

  <style>
    :root {
      --bg: #0b0f17;
      --panel: #121826;
      --panel-2: #0f1523;
      --text: #e6edf3;
      --muted: #9fb0c0;
      --primary: #3b82f6;
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --surface: #1b2336;
      --ring: 0 0 0 3px rgba(59, 130, 246, .35);
    }

    html, body { height: 100%; }
    body { background: var(--bg); color: var(--text); }

    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-track { background: #0b1220; }
    *::-webkit-scrollbar-thumb { background: #243b55; border-radius: 9999px; }
    *::-webkit-scrollbar-thumb:hover { background: #2f4c6f; }

    .btn { display:inline-flex; align-items:center; justify-content:center; border-radius:0.75rem; padding:0.5rem 1rem; font-size:0.875rem; font-weight:600; transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.1)); box-shadow:0 1px 0 rgba(255,255,255,.06) inset, 0 10px 20px rgba(0,0,0,.15); cursor:pointer; }
    .btn:hover { transform: translateY(-1px) scale(1.02); }
    .btn:active { transform: translateY(0) scale(.98); }
    .btn:focus-visible { outline: none; box-shadow: var(--ring); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .btn-primary { background-color: var(--primary); color: #fff; }
    .btn-accent { background-color: var(--accent); color: #000; }
    .btn-danger { background-color: var(--danger); color: #fff; }
    .btn-ghost { background-color: transparent; color: var(--text); border: 1px solid rgba(255,255,255,.08); }

    .input, .select, .textarea { width:100%; border-radius:0.75rem; padding:0.5rem 0.75rem; font-size:0.875rem; background: var(--surface); border:1px solid rgba(255,255,255,.08); color: var(--text); }
    .input:focus-visible, .select:focus-visible, .textarea:focus-visible { outline: none; box-shadow: var(--ring); }
    .input:invalid { border-color: var(--danger); }

    .panel { background: var(--panel); border: 1px solid rgba(255,255,255,.06); }
    .panel-2 { background: var(--panel-2); border: 1px solid rgba(255,255,255,.06); }

    .modal-backdrop { background: rgba(2, 6, 23, 0.75); opacity: 0; transition: opacity .2s ease; }
    .modal-backdrop[data-open="true"] { opacity: 1; }
    .modal-panel { transform: translateY(12px) scale(.98); opacity: 0; transition: transform .22s ease, opacity .22s ease; }
    .modal-panel[data-open="true"] { transform: translateY(0) scale(1); opacity: 1; }

    .handle { cursor: grab; }
    .handle:active, .handle[aria-grabbed="true"] { cursor: grabbing; }

    .progress-track { height: 6px; background: rgba(255,255,255,.1); border-radius: 9999px; overflow: hidden; }
    .progress-indeterminate { height: 100%; width: 30%; border-radius: 9999px; background: linear-gradient(90deg, var(--primary), var(--accent)); animation: slide 1.1s infinite ease-in-out; }
    @keyframes slide { 0% { transform: translateX(-120%);} 50% { transform: translateX(40%);} 100% { transform: translateX(120%);} }

    .drag-over { border: 2px dashed var(--primary); opacity: 0.7; }
    .drag-placeholder { background: var(--panel-2); border: 2px dashed var(--primary); opacity: 0.5; height: 48px; border-radius: 0.75rem; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="sticky top-0 z-20 border-b border-white/10 backdrop-blur supports-[backdrop-filter]:bg-black/30">
    <div class="mx-auto max-w-5xl px-4 sm:px-6 py-3 flex items-center justify-between">
      <h1 class="text-lg sm:text-2xl font-bold tracking-tight">AI Daily Activity Planner</h1>
      <div class="flex items-center gap-2">
        <button id="openManage" class="btn btn-ghost" aria-haspopup="dialog" aria-controls="manageModal" aria-expanded="false" title="Manage activities list">Manage</button>
      </div>
    </div>
  </header>

  <main class="mx-auto w-full max-w-5xl flex-1 px-4 sm:px-6 py-6 space-y-6">
    <section class="panel rounded-2xl p-4 sm:p-6">
      <h2 class="text-xl font-semibold mb-4" id="plannerHeading">Plan an activity</h2>
      <form id="planForm" class="grid gap-3 sm:grid-cols-12" aria-labelledby="plannerHeading">
        <div class="sm:col-span-4">
          <label for="activitySelect" class="block text-sm mb-1">Activity</label>
          <div class="relative">
            <select id="activitySelect" class="select" aria-label="Select activity" required></select>
            <div id="activityError" class="text-sm text-[color:var(--danger)] mt-1 hidden"></div>
          </div>
        </div>
        <div class="sm:col-span-3">
          <label for="durationInput" class="block text-sm mb-1">Duration (hours)</label>
          <input id="durationInput" class="input" type="number" min="0.25" max="24" step="0.25" value="1" aria-label="Duration in hours" required />
          <div id="durationError" class="text-sm text-[color:var(--danger)] mt-1 hidden"></div>
        </div>
        <div class="sm:col-span-5">
          <label for="notesInput" class="block text-sm mb-1">Notes (optional)</label>
          <div class="relative">
            <input id="notesInput" class="input" type="text" placeholder="e.g., after lunch, low intensity" maxlength="100" aria-label="Notes" />
            <span class="absolute right-3 top-2 text-xs text-[color:var(--muted)]" id="notesCounter">0/100</span>
          </div>
        </div>
        <div class="sm:col-span-12 flex gap-2 pt-2">
          <button id="addPlanBtn" class="btn btn-primary" type="submit" aria-label="Add item to plan">Add to plan</button>
          <button id="clearPlanBtn" class="btn btn-danger" type="button" aria-label="Clear plan">Clear plan</button>
        </div>
      </form>
    </section>

    <section class="panel rounded-2xl p-4 sm:p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Today's plan</h2>
        <div class="flex items-center gap-2">
          <button id="exportPlanBtn" class="btn btn-ghost text-sm" type="button" aria-label="Export plan as JSON">Export</button>
          <label for="importPlanInput" class="btn btn-ghost text-sm" aria-label="Import plan from JSON">Import</label>
          <input id="importPlanInput" type="file" accept=".json" class="hidden" />
          <button id="resetToggleBtn" class="btn btn-ghost text-sm" type="button" aria-label="Toggle daily reset at midnight">Reset at Midnight: Off</button>
          <div class="text-sm text-[color:var(--muted)]" id="totalDuration" aria-live="polite"></div>
        </div>
      </div>
      <ul id="planList" class="space-y-3 relative" role="list" aria-label="Planned activities"></ul>
      <p id="emptyState" class="text-sm text-[color:var(--muted)]">No items yet. Add an activity above.</p>
      <div id="chartContainer" class="mt-4 hidden">
        <canvas id="activityChart" height="200"></canvas>
      </div>
    </section>

    <section class="panel rounded-2xl p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <h2 class="text-xl font-semibold">AI Coach</h2>
        <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
          <label class="text-sm" for="modelSelect">Model</label>
          <select id="modelSelect" class="select sm:w-64" aria-label="Select AI model">
            <option value="t5-small">T5-small (text2text)</option>
            <option value="smollm2-135m">SmolLM2-135M (q4, instruct)</option>
          </select>
          <button id="runCoachBtn" class="btn btn-accent" type="button" aria-label="Run AI Coach">Get feedback</button>
          <button id="retryCoachBtn" class="btn btn-ghost hidden" type="button" aria-label="Retry AI Coach">Retry</button>
        </div>
      </div>
      <div id="aiThinking" class="mt-4 hidden" aria-live="assertive">
        <div class="progress-track" role="progressbar" aria-label="AI Coach is thinking" aria-busy="true">
          <div class="progress-indeterminate"></div>
        </div>
        <p class="mt-2 text-sm text-[color:var(--muted)]">AI Coach is thinking… First run may take a moment to initialize.</p>
      </div>
      <div id="aiOutput" class="mt-4 panel-2 rounded-xl p-3 text-sm whitespace-pre-wrap" aria-live="polite"></div>
    </section>
  </main>

  <div id="manageModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="manageTitle" aria-describedby="manageDesc">
    <div class="modal-backdrop absolute inset-0" data-open="false"></div>
    <div class="relative mx-auto max-w-[90vw] sm:w-96 mt-16">
      <div class="modal-panel panel rounded-2xl p-4 sm:p-6" data-open="false">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 id="manageTitle" class="text-lg font-semibold">Manage activities</h2>
            <p id="manageDesc" class="text-sm text-[color:var(--muted)]">Add or remove activities available in the planner.</p>
          </div>
          <button id="closeManage" class="btn btn-ghost" aria-label="Close manage activities modal">✕</button>
        </div>
        <div class="mt-4 space-y-3">
          <div>
            <label for="newActivityInput" class="block text-sm mb-1">Add new activity</label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <input id="newActivityInput" class="input" type="text" placeholder="e.g., Read" maxlength="20" aria-label="New activity" />
                <span class="absolute right-3 top-2 text-xs text-[color:var(--muted)]" id="activityCounter">0/20</span>
              </div>
              <button id="addActivityBtn" class="btn btn-primary" type="button">Add</button>
            </div>
            <div id="newActivityError" class="text-sm text-[color:var(--danger)] mt-1 hidden"></div>
          </div>
          <div>
            <h3 class="text-sm font-semibold mb-2">Current activities</h3>
            <ul id="activityList" class="space-y-2 max-h-64 overflow-auto" aria-label="Current activities"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <template id="activityChipTpl">
    <li class="flex items-center justify-between rounded-xl px-3 py-2 panel-2">
      <span class="text-sm"></span>
      <button class="btn btn-danger text-xs" type="button" aria-label="Delete activity">Delete</button>
    </li>
  </template>

  <template id="planItemTpl">
    <li class="panel-2 rounded-xl p-3 flex items-start gap-3" draggable="true" tabindex="0" role="listitem" aria-grabbed="false">
      <div class="select-none handle text-xl leading-none mt-1" title="Drag to reorder" aria-label="Reorder item">⋮⋮</div>
      <div class="flex-1 min-w-0">
        <div class="flex flex-wrap items-center gap-2">
          <button class="switch-activity btn btn-ghost px-2 py-1 text-sm" type="button" title="Switch activity"></button>
          <span class="text-sm text-[color:var(--muted)]">•</span>
          <span class="duration text-sm"></span>
        </div>
        <div class="notes text-xs text-[color:var(--muted)] mt-1 break-words" id="notes-{id}"></div>
      </div>
      <div class="flex items-center gap-2">
        <button class="edit btn btn-ghost" type="button" aria-label="Edit">✎</button>
        <button class="del btn btn-danger" type="button" aria-label="Delete">🗑</button>
      </div>
    </li>
  </template>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>

  <script>
    const DEFAULT_ACTIVITIES = ["Eat", "Sleep", "Sport", "Laptop", "Bath", "Family"];
    const store = {
      get activities() {
        const raw = localStorage.getItem('planner.activities');
        try { return raw ? JSON.parse(raw) : [...DEFAULT_ACTIVITIES]; }
        catch { return [...DEFAULT_ACTIVITIES]; }
      },
      set activities(list) { localStorage.setItem('planner.activities', JSON.stringify(list)); },
      get plan() {
        const raw = localStorage.getItem('planner.plan');
        try { return raw ? JSON.parse(raw) : []; } catch { return []; }
      },
      set plan(list) { localStorage.setItem('planner.plan', JSON.stringify(list)); },
      get model() { return localStorage.getItem('planner.model') || 't5-small'; },
      set model(v) { localStorage.setItem('planner.model', v); },
      get autoReset() { return localStorage.getItem('planner.autoReset') === 'true'; },
      set autoReset(v) { localStorage.setItem('planner.autoReset', v); }
    };

    let activities = store.activities;
    let plan = store.plan;
    let lastPlan = null;

    const $ = (s, el = document) => el.querySelector(s);
    const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));

    const planForm = $('#planForm');
    const activitySelect = $('#activitySelect');
    const durationInput = $('#durationInput');
    const notesInput = $('#notesInput');
    const addPlanBtn = $('#addPlanBtn');
    const clearPlanBtn = $('#clearPlanBtn');
    const planList = $('#planList');
    const emptyState = $('#emptyState');
    const totalDuration = $('#totalDuration');
    const notesCounter = $('#notesCounter');
    const activityError = $('#activityError');
    const durationError = $('#durationError');
    const exportPlanBtn = $('#exportPlanBtn');
    const importPlanInput = $('#importPlanInput');
    const resetToggleBtn = $('#resetToggleBtn');

    const runCoachBtn = $('#runCoachBtn');
    const retryCoachBtn = $('#retryCoachBtn');
    const modelSelect = $('#modelSelect');
    const aiThinking = $('#aiThinking');
    const aiOutput = $('#aiOutput');

    const manageModal = $('#manageModal');
    const openManage = $('#openManage');
    const closeManage = $('#closeManage');
    const newActivityInput = $('#newActivityInput');
    const addActivityBtn = $('#addActivityBtn');
    const activityList = $('#activityList');
    const activityCounter = $('#activityCounter');
    const newActivityError = $('#newActivityError');
    const activityChipTpl = $('#activityChipTpl');
    const planItemTpl = $('#planItemTpl');

    modelSelect.value = store.model;
    resetToggleBtn.textContent = `Reset at Midnight: ${store.autoReset ? 'On' : 'Off'}`;

    let lastFocused = null;
    function trapFocus(container, e) {
      const focusables = $$('[tabindex]:not([tabindex="-1"]),button,input,select,textarea', container)
        .filter(el => !el.hasAttribute('disabled') && !el.closest('[hidden]'));
      if (!focusables.length) return;
      const first = focusables[0], last = focusables[focusables.length - 1];
      if (e.key === 'Tab') {
        e.preventDefault();
        if (e.shiftKey && document.activeElement === first) last.focus();
        else if (!e.shiftKey && document.activeElement === last) first.focus();
        else if (!focusables.includes(document.activeElement)) first.focus();
      } else if (e.key === 'Escape') { closeModal(manageModal); }
    }
    function openModal(modal) {
      lastFocused = document.activeElement;
      modal.classList.remove('hidden');
      $('.modal-backdrop', modal).setAttribute('data-open', 'true');
      $('.modal-panel', modal).setAttribute('data-open', 'true');
      modal.addEventListener('keydown', onModalKeydown);
      setTimeout(() => { ($('#newActivityInput') || $('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])', modal))?.focus({ preventScroll: true }); }, 0);
      openManage.setAttribute('aria-expanded', 'true');
    }
    function closeModal(modal) {
      $('.modal-backdrop', modal).setAttribute('data-open', 'false');
      $('.modal-panel', modal).setAttribute('data-open', 'false');
      modal.removeEventListener('keydown', onModalKeydown);
      setTimeout(() => modal.classList.add('hidden'), 180);
      lastFocused?.focus();
      openManage.setAttribute('aria-expanded', 'false');
    }
    const onModalKeydown = e => trapFocus(manageModal, e);
    $('.modal-backdrop', manageModal).addEventListener('click', () => closeModal(manageModal));
    openManage.addEventListener('click', () => openModal(manageModal));
    closeManage.addEventListener('click', () => closeModal(manageModal));

    function showError(element, message) {
      element.textContent = message;
      element.classList.remove('hidden');
      setTimeout(() => element.classList.add('hidden'), 3000);
    }

    function renderActivitySelect() {
      activitySelect.innerHTML = '';
      for (const name of activities) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        activitySelect.appendChild(opt);
      }
    }
    function renderActivityList() {
      activityList.innerHTML = '';
      for (const name of activities) {
        const li = activityChipTpl.content.firstElementChild.cloneNode(true);
        $('span', li).textContent = name;
        $('button', li).addEventListener('click', () => {
          if (activities.length <= 1) {
            showError(newActivityError, 'At least one activity required. Resetting to defaults.');
            activities = [...DEFAULT_ACTIVITIES];
            store.activities = activities;
          } else {
            activities = activities.filter(a => a !== name);
            store.activities = activities;
          }
          renderActivityList();
          renderActivitySelect();
          renderPlan();
        });
        activityList.appendChild(li);
      }
    }
    addActivityBtn.addEventListener('click', () => {
      const raw = newActivityInput.value.trim();
      if (!raw) return showError(newActivityError, 'Enter an activity name.');
      const name = raw.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, ' ').slice(0, 20);
      if (!name) return showError(newActivityError, 'Invalid name (letters/numbers/spaces).');
      if (activities.some(a => a.toLowerCase() === name.toLowerCase())) return showError(newActivityError, 'Activity already exists.');
      activities.push(name);
      store.activities = activities;
      newActivityInput.value = '';
      activityCounter.textContent = '0/20';
      renderActivityList();
      renderActivitySelect();
    });
    newActivityInput.addEventListener('input', () => {
      activityCounter.textContent = `${newActivityInput.value.length}/20`;
    });

    function addToPlan(activity, duration, notes) {
      plan.push({ id: crypto.randomUUID(), activity, duration, notes });
      store.plan = plan;
      renderPlan();
    }
    let editId = null;
    planForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const activity = activitySelect.value;
      const duration = parseFloat(durationInput.value);
      const notes = notesInput.value.trim().slice(0, 100);
      if (!activity) return showError(activityError, 'Please select an activity.');
      if (!Number.isFinite(duration) || duration <= 0 || duration > 24) return showError(durationError, 'Duration must be between 0.25 and 24 hours.');
      if (editId) {
        const idx = plan.findIndex(x => x.id === editId);
        if (idx !== -1) {
          plan[idx].activity = activity;
          plan[idx].duration = duration;
          plan[idx].notes = notes;
          store.plan = plan;
        }
        editId = null;
        addPlanBtn.textContent = 'Add to plan';
      } else {
        addToPlan(activity, duration, notes);
      }
      notesInput.value = '';
      notesCounter.textContent = '0/100';
      renderPlan();
    });
    clearPlanBtn.addEventListener('click', () => {
      if (!plan.length) return;
      if (clearPlanBtn.textContent === 'Undo') {
        if (lastPlan) {
          plan = lastPlan;
          store.plan = plan;
          renderPlan();
          clearPlanBtn.textContent = 'Clear plan';
        }
        return;
      }
      if (confirm('Clear all plan items?')) {
        lastPlan = [...plan];
        plan = [];
        store.plan = plan;
        renderPlan();
        clearPlanBtn.textContent = 'Undo';
        setTimeout(() => { clearPlanBtn.textContent = 'Clear plan'; }, 5000);
      }
    });
    notesInput.addEventListener('input', () => {
      notesCounter.textContent = `${notesInput.value.length}/100`;
    });

    function exportPlan() {
      if (!plan.length) return showError(totalDuration, 'No plan items to export.');
      const data = JSON.stringify(plan, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `plan-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
    function importPlan(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported) || !imported.every(item => 
            typeof item.id === 'string' &&
            typeof item.activity === 'string' && activities.includes(item.activity) &&
            typeof item.duration === 'number' && item.duration > 0 && item.duration <= 24 &&
            (typeof item.notes === 'string' || item.notes === undefined)
          )) {
            throw new Error('Invalid plan format');
          }
          plan = imported.map(item => ({ ...item, id: crypto.randomUUID() }));
          store.plan = plan;
          renderPlan();
          showError(totalDuration, 'Plan imported successfully.');
        } catch (err) {
          showError(totalDuration, 'Invalid JSON file. Please upload a valid plan.');
        }
        importPlanInput.value = '';
      };
      reader.readAsText(file);
    }
    exportPlanBtn.addEventListener('click', exportPlan);
    importPlanInput.addEventListener('change', importPlan);

    function resetPlan() {
      if (!plan.length) return;
      lastPlan = [...plan];
      plan = [];
      store.plan = plan;
      renderPlan();
      showError(totalDuration, 'Plan reset for new day.');
      clearPlanBtn.textContent = 'Undo';
      setTimeout(() => { clearPlanBtn.textContent = 'Clear plan'; }, 5000);
    }

    function checkMidnightReset() {
      if (!store.autoReset) return;
      const now = new Date();
      const midnight = new Date(now);
      midnight.setHours(24, 0, 0, 0);
      if (now >= midnight) {
        const lastReset = localStorage.getItem('planner.lastReset');
        const today = now.toDateString();
        if (lastReset !== today) {
          resetPlan();
          localStorage.setItem('planner.lastReset', today);
        }
      }
      setTimeout(checkMidnightReset, 60000);
    }

    resetToggleBtn.addEventListener('click', () => {
      if (store.autoReset) {
        store.autoReset = false;
        resetToggleBtn.textContent = 'Reset at Midnight: Off';
        showError(totalDuration, 'Auto-reset disabled.');
      } else {
        store.autoReset = true;
        resetToggleBtn.textContent = 'Reset at Midnight: On';
        showError(totalDuration, 'Auto-reset enabled. Plan will clear at midnight.');
        checkMidnightReset();
        if (plan.length) {
          if (confirm('Reset plan now for today?')) resetPlan();
        }
      }
    });

    function renderPlan() {
      planList.innerHTML = '';
      if (!plan.length) {
        emptyState.classList.remove('hidden');
        chartContainer.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        chartContainer.classList.remove('hidden');
      }
      let total = 0;
      for (const item of plan) {
        total += Number(item.duration) || 0;
        const li = planItemTpl.content.firstElementChild.cloneNode(true);
        li.dataset.id = item.id;
        li.setAttribute('aria-describedby', `notes-${item.id}`);
        $('.switch-activity', li).textContent = item.activity;
        $('.duration', li).textContent = `${item.duration}h`;
        $('.notes', li).textContent = item.notes || '';
        $('.notes', li).id = `notes-${item.id}`;

        $('.switch-activity', li).addEventListener('click', (ev) => {
          const menu = makeSwitchMenu(item, ev.currentTarget);
          ev.currentTarget.insertAdjacentElement('afterend', menu);
          const onDoc = (e) => { if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener('click', onDoc); } };
          setTimeout(() => document.addEventListener('click', onDoc), 0);
        });
        $('.edit', li).addEventListener('click', () => editItem(item.id));
        $('.del', li).addEventListener('click', () => delItem(item.id));

        li.addEventListener('dragstart', onDragStart);
        li.addEventListener('dragover', onDragOver);
        li.addEventListener('dragend', onDragEnd);
        li.addEventListener('drop', onDrop);

        li.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            dragId = li.dataset.id;
            li.setAttribute('aria-grabbed', 'true');
            $('.handle', li).focus();
          } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            e.preventDefault();
            const idx = plan.findIndex(x => x.id === li.dataset.id);
            const to = e.key === 'ArrowUp' ? idx - 1 : idx + 1;
            if (to >= 0 && to < plan.length) {
              [plan[idx], plan[to]] = [plan[to], plan[idx]];
              store.plan = plan;
              renderPlan();
              planList.children[to].focus();
            }
          } else if (e.key === 'Escape' && li.getAttribute('aria-grabbed') === 'true') {
            li.setAttribute('aria-grabbed', 'false');
            dragId = null;
          }
        });

        planList.appendChild(li);
      }
      totalDuration.textContent = plan.length ? `Total: ${total.toFixed(2)} h` : '';
      renderChart();
    }

    let chartInstance = null;
    function renderChart() {
      if (chartInstance) chartInstance.destroy();
      const ctx = $('#activityChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: plan.map(p => p.activity),
          datasets: [{
            data: plan.map(p => p.duration),
            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
            borderColor: ['#1e3a8a', '#065f46', '#b45309', '#991b1b', '#5b21b6', '#be185d'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { position: 'top', labels: { color: '#e6edf3' } },
            title: { display: true, text: 'Activity Time Allocation', color: '#e6edf3', font: { size: 16 } }
          },
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function makeSwitchMenu(item, anchor) {
      const menu = document.createElement('div');
      menu.className = 'absolute z-10 mt-1 panel rounded-xl p-2 shadow-xl border border-white/10';
      menu.role = 'menu';
      menu.style.position = 'absolute';
      menu.style.minWidth = anchor.offsetWidth + 'px';
      const rect = anchor.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      menu.style.left = rect.left + 'px';
      menu.style.top = (rect.bottom + 6) + 'px';
      if (rect.bottom + 150 > viewportHeight) {
        menu.style.top = (rect.top - 150 - 6) + 'px';
      }
      for (const name of activities) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-ghost w-full justify-start text-sm';
        btn.type = 'button';
        btn.textContent = name;
        btn.addEventListener('click', () => {
          item.activity = name;
          store.plan = plan;
          renderPlan();
          menu.remove();
        });
        menu.appendChild(btn);
      }
      return menu;
    }
    function editItem(id) {
      const idx = plan.findIndex(x => x.id === id);
      if (idx === -1) return;
      const it = plan[idx];
      activitySelect.value = it.activity;
      durationInput.value = it.duration;
      notesInput.value = it.notes || '';
      notesCounter.textContent = `${notesInput.value.length}/100`;
      editId = id;
      addPlanBtn.textContent = 'Save';
      activitySelect.focus();
    }
    function delItem(id) {
      const idx = plan.findIndex(x => x.id === id);
      if (idx === -1) return;
      plan.splice(idx, 1);
      store.plan = plan;
      renderPlan();
    }
    let dragId = null;
    let placeholder = null;
    function onDragStart(e) {
      dragId = e.currentTarget.dataset.id;
      e.currentTarget.setAttribute('aria-grabbed', 'true');
      e.currentTarget.style.opacity = '0.4';
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setDragImage(e.currentTarget.cloneNode(true), 0, 0);
      placeholder = document.createElement('li');
      placeholder.className = 'drag-placeholder';
      placeholder.setAttribute('aria-hidden', 'true');
    }
    function onDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const target = e.currentTarget;
      if (target.dataset.id === dragId) return;
      target.classList.add('drag-over');
      const rect = target.getBoundingClientRect();
      const isAbove = e.clientY < rect.top + rect.height / 2;
      if (placeholder && !target.contains(placeholder)) {
        target.parentNode.insertBefore(placeholder, isAbove ? target : target.nextSibling);
      }
    }
    function onDragEnd(e) {
      e.currentTarget.style.opacity = '1';
      e.currentTarget.setAttribute('aria-grabbed', 'false');
      $$('.drag-over', planList).forEach(el => el.classList.remove('drag-over'));
      if (placeholder) {
        placeholder.remove();
        placeholder = null;
      }
      dragId = null;
    }
    function onDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      const targetId = e.currentTarget.dataset.id;
      e.currentTarget.setAttribute('aria-grabbed', 'false');
      if (!dragId || dragId === targetId || !placeholder) return;
      const from = plan.findIndex(x => x.id === dragId);
      const to = Array.from(planList.children).indexOf(placeholder);
      const [moved] = plan.splice(from, 1);
      plan.splice(to, 0, moved);
      store.plan = plan;
      renderPlan();
      dragId = null;
      placeholder.remove();
      placeholder = null;
    }

    let pipelineRef = null, loadedKey = null, trf = null, isRunning = false;

    modelSelect.addEventListener('change', () => { store.model = modelSelect.value; });
    runCoachBtn.addEventListener('click', runAICoach);
    retryCoachBtn.addEventListener('click', runAICoach);

    async function runAICoach() {
      if (isRunning) return;
      isRunning = true;
      retryCoachBtn.classList.add('hidden');
      try {
        const summary = makePlanSummary(plan);
        if (!summary.trim()) {
          aiOutput.textContent = 'Add some activities first.';
          return;
        }
        setThinking(true);
        if (!loadedKey) aiOutput.textContent = 'Initializing AI model (first run may take a moment)...';
        const out = await generateWithFallback(modelSelect.value, summary);
        aiOutput.textContent = out;
      } catch (err) {
        console.error('AI Coach error:', err);
        const tips = [
          location.protocol === 'file:' ? 'Serve via http:// (e.g., python -m http.server) to avoid cross-origin issues.' : null,
          'Allow cdn.jsdelivr.net / unpkg.com in adblock/VPN.',
          'Try another network if a firewall blocks CDNs.'
        ].filter(Boolean).map(t => '• ' + t).join('\n');
        aiOutput.textContent = `AI unavailable. Try again or check your network.\n\nTroubleshooting:\n${tips}\n\nFalling back to rule-based feedback:\n\n${ruleBasedCoach(plan)}`;
        retryCoachBtn.classList.remove('hidden');
      } finally {
        setThinking(false);
        isRunning = false;
      }
    }

    async function generateWithFallback(selected, summary) {
      const order = selected === 't5-small' ? ['t5-small', 'smollm2-135m'] : ['smollm2-135m', 't5-small'];
      let lastErr = null;
      for (const key of order) {
        try { return await generateWithModel(key, summary); } catch (e) { lastErr = e; }
      }
      throw lastErr ?? new Error('AI failed');
    }

    function modelConfig(key) {
      if (key === 't5-small') {
        return {
          task: 'text2text-generation',
          model: 'Xenova/t5-small',
          opts: { dtype: 'q8' },
          generation: { max_new_tokens: 200, temperature: 0.7, repetition_penalty: 1.1 }
        };
      } else {
        return {
          task: 'text-generation',
          model: 'Xenova/SmolLM2-135M-Instruct',
          opts: { dtype: 'q4' },
          generation: { max_new_tokens: 220, temperature: 0.75, top_k: 40, repetition_penalty: 1.1 }
        };
      }
    }
    function buildPrompt(summary, key) {
      const sys = 'You are an elite productivity coach. Analyze the plan and provide a concise review with 3–5 specific, actionable suggestions (e.g., adjust timing, swap activities) in bullet points. Include a balance score (1–10).';
      return key === 't5-small' ? `${sys}\nPlan:\n${summary}\nRespond:` : `${sys}\n\nPlan:\n${summary}\n\nCoach:`;
    }
    function setThinking(on) {
      aiThinking.classList.toggle('hidden', !on);
      runCoachBtn.disabled = on;
      runCoachBtn.textContent = on ? 'Thinking…' : 'Get feedback';
    }
    function makePlanSummary(plan) {
      if (!plan.length) return '';
      const lines = plan.map((p, i) => `${i + 1}. ${p.activity} — ${p.duration}h${p.notes ? ` (${p.notes})` : ''}`);
      const total = plan.reduce((s, p) => s + (Number(p.duration) || 0), 0).toFixed(2);
      return lines.join('\n') + `\nTotal: ${total}h`;
    }
    function ruleBasedCoach(plan) {
      if (!plan.length) return 'No items to assess.';
      const total = plan.reduce((s, p) => s + (Number(p.duration) || 0), 0);
      const hasSleep = plan.some(p => /sleep/i.test(p.activity));
      const hasSport = plan.some(p => /sport|run|gym|workout/i.test(p.activity));
      const hasEat = plan.some(p => /eat|meal|breakfast|lunch|dinner/i.test(p.activity));
      const lines = [];
      lines.push('Rule-based feedback (offline):');
      lines.push(`• Total planned time: ${total.toFixed(2)}h (aim for 6–12h)`);
      if (!hasSleep) lines.push('• Consider adding Sleep for recovery.');
      if (!hasSport) lines.push('• Add a short Sport/Walk for energy and mood.');
      if (!hasEat) lines.push('• Include regular meals for steady energy.');
      lines.push('• Alternate focus (Laptop/Work) with lighter blocks (Walk/Stretch).');
      lines.push('• Keep blocks 0.5–2h to minimize fatigue.');
      lines.push('• Balance score: ' + (hasSleep && hasSport && hasEat ? '8/10' : '5/10'));
      return lines.join('\n');
    }

    async function ensurePipeline(key) {
      await ensureTransformersUMD();
      const { pipeline, env } = trf;
      env.allowLocalModels = false;
      env.useBrowserCache = true;
      env.backends = env.backends || {};
      env.backends.onnx = env.backends.onnx || {};
      env.backends.onnx.wasm = env.backends.onnx.wasm || {};
      env.backends.onnx.wasm.numThreads = 1;
      env.backends.onnx.wasm.proxy = true;
      const cfg = modelConfig(key);
      if (loadedKey !== key) {
        try { env.clearCache?.(); } catch {}
        pipelineRef = await pipeline(cfg.task, cfg.model, cfg.opts);
        loadedKey = key;
        try { await withTimeout(pipelineRef('Hello', cfg.generation), 15000); } catch {}
      }
      return pipelineRef;
    }
    async function generateWithModel(key, summary) {
      try {
        const cfg = modelConfig(key);
        const pipe = await ensurePipeline(key);
        const prompt = buildPrompt(summary, key);
        const result = await withTimeout(pipe(prompt, cfg.generation), 45000);
        const text = Array.isArray(result) ? (result[0]?.generated_text ?? result[0]?.summary_text ?? '')
                                          : (result?.generated_text || result?.summary_text || '');
        return text.trim() || 'AI returned empty output. Using rule-based feedback.\n\n' + ruleBasedCoach(plan);
      } catch (err) {
        console.error(`AI model (${key}) failed:`, err);
        throw new Error('AI unavailable. Try again or check your network.');
      }
    }
    function withTimeout(promise, ms) {
      return new Promise((resolve, reject) => {
        const t = setTimeout(() => reject(new Error('Timed out.')), ms);
        promise.then(v => { clearTimeout(t); resolve(v); }, e => { clearTimeout(t); reject(e); });
      });
    }

    async function ensureTransformersUMD() {
      if (trf) return trf;
      const cacheKey = 'transformers-js-cache-v372';
      const cachedScript = localStorage.getItem(cacheKey);
      if (cachedScript) {
        try {
          const script = document.createElement('script');
          script.textContent = cachedScript;
          document.head.appendChild(script);
          if (window.transformers) {
            trf = window.transformers;
            return trf;
          }
        } catch (e) {
          console.error('Failed to load cached Transformers.js:', e);
        }
      }
      const urls = [
        'https://cdn.jsdelivr.net/npm/@xenova/transformers@3.7.2/dist/transformers.min.js',
        'https://cdn.jsdelivr.net/npm/@xenova/transformers@3.7.2/dist/transformers.js',
        'https://unpkg.com/@xenova/transformers@3.7.2/dist/transformers.min.js',
        'https://unpkg.com/@xenova/transformers@3.7.2/dist/transformers.js'
      ];
      let lastErr;
      for (const src of urls) {
        try {
          const response = await fetch(src, { mode: 'cors' });
          if (!response.ok) throw new Error(`Failed to fetch ${src}: ${response.status}`);
          const text = await response.text();
          const script = document.createElement('script');
          script.textContent = text;
          document.head.appendChild(script);
          if (window.transformers) {
            try { localStorage.setItem(cacheKey, text); } catch {}
            trf = window.transformers;
            return trf;
          }
        } catch (e) {
          lastErr = e;
          console.error(`Failed to load ${src}:`, e);
        }
      }
      throw lastErr ?? new Error('Failed to load transformers from all CDNs');
    }

    async function preloadModels() {
      for (const key of ['t5-small', 'smollm2-135m']) {
        try { await ensurePipeline(key); } catch {}
      }
    }

    function init() {
      renderActivitySelect();
      renderActivityList();
      renderPlan();
      notesCounter.textContent = '0/100';
      activityCounter.textContent = '0/20';
      preloadModels();
      if (store.autoReset) checkMidnightReset();
    }
    init();
  </script>
</body>
</html>
