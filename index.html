<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Daily Activity Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">
  <!-- Header -->
  <header class="bg-gray-800 p-4 text-center text-xl font-bold">
    AI Daily Activity Tracker
  </header>

  <!-- Logs -->
  <main class="flex-1 p-4 overflow-y-auto">
    <div id="log" class="space-y-4"></div>
  </main>

  <!-- Floating buttons -->
  <div class="fixed bottom-4 right-4 space-y-2">
    <button id="fabBtn" class="bg-green-600 p-4 rounded-full shadow">‚ûï</button>
    <button id="clearBtn" class="bg-red-600 p-4 rounded-full shadow">üóëÔ∏è</button>
    <button id="manageBtn" class="bg-blue-600 p-4 rounded-full shadow">‚öôÔ∏è</button>
  </div>

  <!-- Log Modal -->
  <div id="logModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-80">
      <h2 class="text-lg font-bold mb-2">Log Activity</h2>
      <select id="activitySelect" class="w-full p-2 text-black rounded mb-2"></select>
      <label class="flex items-center space-x-2 text-sm mb-2">
        <input type="checkbox" id="aiToggle" />
        <span>Enable AI Coach</span>
      </label>
      <div id="modelInfo" class="text-xs text-yellow-400 mb-2 hidden"></div>
      <button id="logBtn" class="w-full bg-green-600 p-2 rounded">Log</button>
    </div>
  </div>

  <!-- Manage Modal -->
  <div id="manageModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-80">
      <h2 class="text-lg font-bold mb-2">Manage Activities</h2>
      <input id="newActivityInput" type="text" placeholder="New activity"
             class="w-full p-2 text-black rounded mb-2" />
      <button id="addActivityBtn" class="w-full bg-blue-600 p-2 rounded mb-4">Add</button>
      <ul id="activityList" class="space-y-1 mb-4"></ul>
      <button id="backBtn" class="w-full bg-gray-600 p-2 rounded">‚¨Ö Go Back</button>
    </div>
  </div>

  <!-- Spinner -->
  <div id="spinner" class="hidden fixed bottom-16 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black p-2 rounded shadow">
    <span id="spinnerText">Loading AI Coach‚Ä¶</span>
    <div class="w-40 bg-gray-300 h-2 mt-1 rounded">
      <div id="progressBar" class="bg-green-600 h-2 rounded" style="width:0%"></div>
    </div>
  </div>

  <!-- Footer version -->
  <footer class="bg-gray-800 text-xs p-1 absolute bottom-0 left-0">
    Testversion 0.27
  </footer>

  <script type="module">
    const fabBtn = document.getElementById("fabBtn");
    const clearBtn = document.getElementById("clearBtn");
    const manageBtn = document.getElementById("manageBtn");
    const backBtn = document.getElementById("backBtn");
    const logModal = document.getElementById("logModal");
    const manageModal = document.getElementById("manageModal");
    const logBtn = document.getElementById("logBtn");
    const activitySelect = document.getElementById("activitySelect");
    const aiToggle = document.getElementById("aiToggle");
    const newActivityInput = document.getElementById("newActivityInput");
    const addActivityBtn = document.getElementById("addActivityBtn");
    const activityList = document.getElementById("activityList");
    const log = document.getElementById("log");
    const spinner = document.getElementById("spinner");
    const spinnerText = document.getElementById("spinnerText");
    const progressBar = document.getElementById("progressBar");
    const modelInfo = document.getElementById("modelInfo");

    const STORAGE_KEYS = { ACTIVITIES: "activityList", LOGS: "activityLogs" };
    let activities = JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVITIES)) ||
      ["Eat","Sleep","Work","Exercise","Study","Commute","Socialize","Relax","Shop","Cook"];
    let logs = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOGS)) || [];
    let generator = null;
    let activeModel = null;

    function sanitize(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }
    function save(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    }

    function renderActivities() {
      activitySelect.innerHTML = "";
      activities.forEach(act => {
        const opt = document.createElement("option");
        opt.textContent = act; activitySelect.appendChild(opt);
      });
      activityList.innerHTML = "";
      activities.forEach((act, i) => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${sanitize(act)}</span>
          <button class="bg-red-600 px-2 rounded ml-2" onclick="removeActivity(${i})">‚úï</button>`;
        activityList.appendChild(li);
      });
    }

    window.removeActivity = (i) => {
      activities.splice(i,1);
      save(STORAGE_KEYS.ACTIVITIES,activities);
      renderActivities();
    };

    function renderLogs() {
      log.innerHTML = "";
      logs.forEach(l => {
        const div = document.createElement("div");
        div.className="p-3 bg-gray-800 rounded";
        div.innerHTML = `<div class="font-bold">${sanitize(l.activity)} <span class="text-xs">(${l.time})</span></div>
                         <div class="text-sm mt-1">${sanitize(l.feedback)}</div>`;
        log.appendChild(div);
      });
    }

    function ruleFeedback(act) {
      const fb = {
        Eat:"üçΩÔ∏è Good to stay nourished!",
        Sleep:"üò¥ Rest is essential.",
        Work:"üíº Keep focused!",
        Exercise:"üèÉ Great energy boost.",
        Study:"üìö Knowledge is power.",
        Commute:"üöå Time well spent traveling.",
        Socialize:"ü§ù Stay connected.",
        Relax:"üßò Calm and balanced.",
        Shop:"üõí Don‚Äôt overspend!",
        Cook:"üë©‚Äçüç≥ Healthy eating starts here."
      };
      return fb[act] || "Keep it up!";
    }

    async function loadModel(retries=2){
      if(!navigator.onLine){alert("‚ö†Ô∏è Offline. AI Coach needs internet."); aiToggle.checked=false; return null;}
      if(!window.WebAssembly){alert("‚ö†Ô∏è Browser lacks WebAssembly."); aiToggle.checked=false; return null;}
      spinner.classList.remove("hidden"); spinnerText.textContent="Downloading AI Coach (~70MB)‚Ä¶";
      progressBar.style.width="0%";
      try{
        const {pipeline}=await import("https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.7.2");
        activeModel = "Xenova/distilgpt2";
        return await Promise.race([
          pipeline("text-generation", activeModel, {
            progress_callback:(p)=>{if(p.loaded&&p.total){const pct=Math.floor((p.loaded/p.total)*100);
              progressBar.style.width=pct+"%"; spinnerText.textContent=`Downloading‚Ä¶ ${pct}% (~70MB)`;}}
          }),
          new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),300000)) // 5 min timeout
        ]);
      }catch(e){
        if(retries>0) return loadModel(retries-1);
        console.error("AI load fail",e); alert("‚ö†Ô∏è Failed: "+e.message); aiToggle.checked=false; return null;
      }finally{spinner.classList.add("hidden");}
    }

    async function aiCoachFeedback(act){
      try{
        const out=await Promise.race([
          generator(act,{max_new_tokens:80}),
          new Promise((_,rej)=>setTimeout(()=>rej(new Error("AI timeout")),10000))
        ]);
        let txt=out[0].generated_text;
        if(txt.startsWith(act)) txt=txt.slice(act.length);
        return sanitize(txt.trim().split(/(?<=[.!?])\s+/).slice(0,4).join(" "))||"Keep it up!";
      }catch{throw new Error("AI feedback fail");}
    }

    fabBtn.onclick=()=>{logModal.classList.remove("hidden");};
    manageBtn.onclick=()=>{manageModal.classList.remove("hidden");};
    backBtn.onclick=()=>{manageModal.classList.add("hidden");};
    clearBtn.onclick=()=>{if(confirm("Clear all logs?")){logs=[]; save(STORAGE_KEYS.LOGS,logs); renderLogs();}};
    addActivityBtn.onclick=()=>{
      const val=newActivityInput.value.trim(); if(val&&!activities.includes(val)){
        activities.push(val); save(STORAGE_KEYS.ACTIVITIES,activities); renderActivities(); newActivityInput.value="";
      }
    };
    aiToggle.onchange=async()=>{if(aiToggle.checked&&!generator){generator=await loadModel(); if(generator){spinnerText.textContent="‚úÖ AI Coach ready"; modelInfo.textContent=`Active model: ${activeModel}`; modelInfo.classList.remove("hidden");}}};

    logBtn.onclick=async()=>{
      const act=activitySelect.value;
      const entry={activity:act,time:new Date().toLocaleString(),feedback:"ü§ñ AI Coach is thinking..."};
      logs.push(entry); save(STORAGE_KEYS.LOGS,logs); renderLogs();
      const idx=logs.length-1;
      if(aiToggle.checked&&generator){
        try{logs[idx].feedback=await aiCoachFeedback(act);}catch{logs[idx].feedback="‚ö†Ô∏è AI Coach error. "+ruleFeedback(act);}
      }else{logs[idx].feedback=aiToggle.checked?"‚ö†Ô∏è AI Coach unavailable. "+ruleFeedback(act):ruleFeedback(act);}
      save(STORAGE_KEYS.LOGS,logs); renderLogs(); logModal.classList.add("hidden");
    };

    renderActivities(); renderLogs();
  </script>
</body>
</html>
