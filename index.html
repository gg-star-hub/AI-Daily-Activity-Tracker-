<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen 2.5 (0.5B) - Local AI</title>
    
    <!-- Markdown Support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --bg:#0f172a; --chat:#1e293b; --input:#334155; --accent:#3b82f6; --text:#f8fafc; }
        body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        
        /* Loader */
        #loader { position:absolute; inset:0; background:var(--bg); z-index:99; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:opacity 0.5s; }
        .box { background:var(--chat); padding:2rem; border-radius:12px; width:90%; max-width:400px; text-align:center; border:1px solid var(--input); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .bar-bg { width:100%; height:8px; background:#020617; border-radius:4px; margin:15px 0; overflow:hidden; }
        .bar { height:100%; background:var(--accent); width:0%; transition:width 0.2s; }
        #status { margin:0 0 10px 0; font-weight:600; }
        
        /* Chat */
        #app { display:flex; flex-direction:column; height:100%; opacity:0; transition:opacity 0.5s; pointer-events:none; }
        #app.active { pointer-events:all; }
        header { padding:15px; background:var(--chat); border-bottom:1px solid var(--input); font-weight:600; display:flex; justify-content:space-between; align-items:center; }
        #msgs { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px; scroll-behavior:smooth; }
        .msg { max-width:85%; padding:10px 15px; border-radius:10px; line-height:1.5; font-size:0.95rem; word-wrap:break-word; }
        .msg p { margin:0; }
        .user { align-self:flex-end; background:var(--accent); color:white; }
        .bot { align-self:flex-start; background:var(--chat); border:1px solid var(--input); }
        .bot pre { background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; overflow-x:auto; }
        
        #input-area { padding:20px; background:var(--chat); border-top:1px solid var(--input); display:flex; gap:10px; }
        input { flex:1; padding:12px; border-radius:8px; border:1px solid var(--input); background:var(--bg); color:white; outline:none; }
        button { padding:0 20px; background:var(--accent); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; }
        button:disabled { background:var(--input); cursor:wait; }
    </style>

    <!-- COI Security Injector (Fixed to allow Caching) -->
    <script>
    (function() {
        if (window.crossOriginIsolated) return; 
        
        const workerScript = `
            self.addEventListener("install", () => self.skipWaiting());
            self.addEventListener("activate", e => e.waitUntil(self.clients.claim()));
            self.addEventListener("fetch", e => {
                // Only intercept the main document to inject security headers.
                // We let other requests (like the model download) go through normally to avoid breaking the Cache API.
                if (e.request.mode === "navigate" || e.request.destination === "document") {
                    e.respondWith(fetch(e.request).then(res => {
                        const headers = new Headers(res.headers);
                        headers.set("Cross-Origin-Embedder-Policy", "require-corp");
                        headers.set("Cross-Origin-Opener-Policy", "same-origin");
                        return new Response(res.body, { status: res.status, statusText: res.statusText, headers });
                    }));
                }
            });
        `;
        
        const blob = new Blob([workerScript], { type: "application/javascript" });
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url).then(reg => {
            reg.addEventListener("updatefound", () => location.reload());
            if (reg.active && !navigator.serviceWorker.controller) location.reload();
        }).catch(err => {
            console.error(err);
            document.getElementById("status").textContent = "Error: Use a local server (http://localhost), not file://";
        });
    })();
    </script>
</head>
<body>

<div id="loader">
    <div class="box">
        <h2 id="status">Initializing...</h2>
        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#94a3b8;">
            <span id="pct">0%</span>
            <span id="txt">Preparing</span>
        </div>
        <div class="bar-bg"><div id="bar" class="bar"></div></div>
    </div>
</div>

<div id="app">
    <header>
        <span>Local Chat</span>
        <span style="font-size:0.8em; opacity:0.7; border:1px solid #334155; padding:2px 6px; border-radius:4px;">Qwen 2.5 (0.5B)</span>
    </header>
    <div id="msgs"></div>
    <div id="input-area">
        <input type="text" id="inp" placeholder="Type a message..." autocomplete="off">
        <button id="btn">Send</button>
    </div>
</div>

<script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm@0.2.46";

    const MODEL = "Qwen2.5-0.5B-Instruct-q4f32_1-MLC";
    const CONFIG = {
        model_list: [{
            "model": "https://huggingface.co/mlc-ai/Qwen2.5-0.5B-Instruct-q4f32_1-MLC/resolve/main/",
            "model_id": MODEL,
            "model_lib": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-models/v0.2.46/Qwen2-0.5B-Instruct-q4f32_1-ctx4k_cs1k-webgpu.wasm",
            "vram_required_MB": 800,
            "low_resource_required": true
        }]
    };

    const $ = id => document.getElementById(id);
    let engine;
    let hist = [{ role:"system", content:"You are a helpful AI assistant." }];

    async function init() {
        if(!navigator.gpu) { 
            $("status").textContent = "WebGPU not supported (Use Chrome/Edge)"; 
            return; 
        }
        
        try {
            engine = await CreateMLCEngine(MODEL, {
                appConfig: CONFIG,
                initProgressCallback: (info) => {
                    $("bar").style.width = info.progress * 100 + "%";
                    $("pct").textContent = Math.floor(info.progress*100) + "%";
                    $("txt").textContent = info.text.replace("Fetching","DL");
                }
            });
            
            $("loader").style.opacity = "0";
            $("app").style.opacity = "1";
            $("app").classList.add("active");
            setTimeout(() => $("loader").style.display = "none", 500);
            add("bot", "Hi! The model is loaded locally. Ask me anything!");
            
        } catch(e) {
            $("status").textContent = "Load Error: " + e.message;
            $("status").style.color = "#ef4444";
            $("txt").textContent = "Check console (F12) for details";
        }
    }

    async function send() {
        const txt = $("inp").value.trim();
        if(!txt) return;
        
        $("inp").value = ""; $("inp").disabled = true; $("btn").disabled = true;
        add("user", txt);
        hist.push({ role:"user", content:txt });
        
        const botDiv = add("bot", "...");
        let full = "";

        try {
            const stream = await engine.chat.completions.create({ messages:hist, stream:true });
            for await (const c of stream) {
                full += c.choices[0]?.delta?.content || "";
                botDiv.innerHTML = marked.parse(full);
                $("msgs").scrollTop = $("msgs").scrollHeight;
            }
            hist.push({ role:"assistant", content:full });
        } catch(e) {
            botDiv.textContent = "Error: " + e.message;
        }
        
        $("inp").disabled = false; $("btn").disabled = false; $("inp").focus();
    }

    function add(role, txt) {
        const d = document.createElement("div");
        d.className = `msg ${role}`;
        d.innerHTML = role === "user" ? txt : marked.parse(txt);
        $("msgs").appendChild(d);
        $("msgs").scrollTop = $("msgs").scrollHeight;
        return d;
    }

    $("btn").onclick = send;
    $("inp").onkeydown = (e) => { if(e.key === "Enter") send(); };

    // Start
    init();

</script>
</body>
</html>
