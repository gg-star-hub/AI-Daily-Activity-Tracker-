<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Daily Activity Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col relative">
  <header class="p-4 text-center text-xl font-bold bg-gray-800">AI Daily Activity Tracker</header>
  <main class="flex-1 p-4 overflow-y-auto" id="log"></main>

  <div class="fixed bottom-4 right-4 space-y-3 flex flex-col">
    <button id="fabBtn" aria-label="Log Activity" class="bg-blue-500 hover:bg-blue-600 text-white p-5 md:p-4 rounded-full shadow">‚ûï</button>
    <button id="clearBtn" aria-label="Clear Logs" class="bg-red-500 hover:bg-red-600 text-white p-5 md:p-4 rounded-full shadow">üóëÔ∏è</button>
    <button id="manageBtn" aria-label="Manage Activities" class="bg-green-500 hover:bg-green-600 text-white p-5 md:p-4 rounded-full shadow">‚öôÔ∏è</button>
  </div>

  <div id="logModal" role="dialog" aria-labelledby="logModalTitle" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-gray-800 p-6 rounded shadow-lg w-full max-w-sm mx-auto">
      <h2 id="logModalTitle" class="text-lg font-bold mb-4">Log Activity</h2>
      <select id="activitySelect" class="w-full mb-4 p-3 bg-gray-700 rounded"></select>
      <label class="flex items-center space-x-2 mb-4">
        <input type="checkbox" id="aiToggle" class="form-checkbox"> <span>Enable AI Coach</span>
      </label>
      <div id="spinner" class="hidden mb-4">
        <div class="w-full bg-gray-600 h-2 rounded"><div id="progressBar" class="bg-blue-500 h-2 rounded" style="width:0%"></div></div>
        <p id="spinnerText" class="text-sm text-gray-300 mt-1">Preparing AI Coach (~66MB)</p>
      </div>
      <div class="flex justify-end space-x-2">
        <button id="cancelLog" class="px-4 py-2 bg-gray-600 rounded w-1/2">Cancel</button>
        <button id="logBtn" class="px-4 py-2 bg-blue-500 rounded w-1/2">Log</button>
      </div>
    </div>
  </div>

  <div id="manageModal" role="dialog" aria-labelledby="manageModalTitle" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-gray-800 p-6 rounded shadow-lg w-full max-w-sm mx-auto">
      <h2 id="manageModalTitle" class="text-lg font-bold mb-4">Manage Activities</h2>
      <ul id="activityList" class="mb-4"></ul>
      <input id="newActivityInput" class="w-full p-3 mb-2 bg-gray-700 rounded" placeholder="New activity">
      <button id="addActivityBtn" class="w-full px-4 py-2 bg-green-500 rounded">Add Activity</button>
      <div class="flex justify-end mt-4"><button id="closeManage" class="px-4 py-2 bg-gray-600 rounded">Close</button></div>
    </div>
  </div>

  <footer class="absolute bottom-2 left-2 text-xs text-gray-500">Testversion 0.17</footer>

<script>
const log = document.getElementById("log");
const logModal = document.getElementById("logModal");
const manageModal = document.getElementById("manageModal");
const activitySelect = document.getElementById("activitySelect");
const aiToggle = document.getElementById("aiToggle");
const spinner = document.getElementById("spinner");
const spinnerText = document.getElementById("spinnerText");
const progressBar = document.getElementById("progressBar");
const activityList = document.getElementById("activityList");
const newActivityInput = document.getElementById("newActivityInput");

let activities = JSON.parse(localStorage.getItem("activityList")||"[]");
if(activities.length===0) activities=["Sleep","Eat","Work","Exercise","Study","Relax","Socialize","Commute","Entertainment","Chores"];
let logs = JSON.parse(localStorage.getItem("activityLogs")||"[]");
let generator=null;

function sanitize(str){return str.replace(/[<>"'&]/g,c=>({"<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#x27;","&":"&amp;"}[c]));}
function save(key,val){try{localStorage.setItem(key,JSON.stringify(val));}catch(e){alert("‚ö†Ô∏è Storage full, data may not be saved.");}}

function renderActivities(){
  activitySelect.innerHTML=""; activities.forEach(a=>{
    const opt=document.createElement("option"); opt.textContent=a; activitySelect.appendChild(opt);
  });
  activityList.innerHTML=""; activities.forEach((a,i)=>{
    const li=document.createElement("li");
    li.className="flex justify-between items-center mb-1";
    li.innerHTML=`<span>${a}</span><button class="text-red-400" data-i="${i}">‚úñ</button>`;
    li.querySelector("button").onclick=()=>{activities.splice(i,1);save("activityList",activities);renderActivities();};
    activityList.appendChild(li);
  });
}
function renderLogs(){
  log.innerHTML=""; logs.forEach(e=>{
    const div=document.createElement("div");
    let border="border-green-400", title="AI Coach says"; 
    if(e.status==="thinking"){border="border-yellow-400"; title="ü§ñ Thinking...";}
    else if(e.status==="fail"){border="border-red-400"; title="AI Coach error";}
    div.className=`bg-gray-800 p-3 rounded border-l-4 ${border} mb-3`;
    div.innerHTML=`<p class="text-xs text-gray-400">${e.time} ‚Äî ${e.activity}</p><p class="font-semibold">${title}</p><p class="text-sm">${e.feedback}</p>`;
    log.appendChild(div);
  });
}

async function aiCoachFeedback(act){
  const out=await generator(act,{max_new_tokens:50});
  return out[0].generated_text.replace(/\n/g," ").slice(act.length).trim();
}
function ruleFeedback(act){
  return {
    "Sleep":"Good rest helps recharge your mind.",
    "Eat":"Balanced meals fuel your body.",
    "Work":"Stay focused, but take short breaks.",
    "Exercise":"Great! Movement boosts energy.",
    "Study":"Consistency leads to mastery.",
    "Relax":"Relaxation restores balance.",
    "Socialize":"Strong bonds support wellbeing.",
    "Commute":"Use this time to reset mentally.",
    "Entertainment":"Fun is vital for balance.",
    "Chores":"Keeping order reduces stress."
  }[act]||"Keep going!";
}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

document.getElementById("fabBtn").onclick=()=>logModal.classList.remove("hidden");
document.getElementById("cancelLog").onclick=()=>logModal.classList.add("hidden");
document.getElementById("manageBtn").onclick=()=>manageModal.classList.remove("hidden");
document.getElementById("closeManage").onclick=()=>manageModal.classList.add("hidden");
document.getElementById("clearBtn").onclick=()=>{if(confirm("Clear all logs?")){logs=[];save("activityLogs",logs);renderLogs();}};
document.getElementById("addActivityBtn").onclick=debounce(()=>{
  const val=sanitize(newActivityInput.value.trim());
  if(!val){alert("Please enter an activity.");return;}
  if(activities.includes(val)){alert("Activity exists.");return;}
  activities.push(val); save("activityList",activities); renderActivities(); newActivityInput.value="";
},300);

document.getElementById("logBtn").onclick=debounce(async()=>{
  const act=activitySelect.value;
  const entry={activity:act,time:new Date().toLocaleString(),feedback:"ü§ñ AI Coach is thinking...",status:"thinking"};
  logs.push(entry); save("activityLogs",logs); renderLogs();
  const idx=logs.length-1;
  if(aiToggle.checked && generator){
    try{logs[idx].feedback=await aiCoachFeedback(act);logs[idx].status="done";}
    catch{logs[idx].feedback=`‚ö†Ô∏è AI Coach error. ${ruleFeedback(act)}`;logs[idx].status="fail";}
  } else if(aiToggle.checked && !generator){
    logs[idx].feedback=`‚ö†Ô∏è AI Coach unavailable. ${ruleFeedback(act)}`;logs[idx].status="fail";
  } else {
    logs[idx].feedback=ruleFeedback(act);logs[idx].status="done";
  }
  save("activityLogs",logs); renderLogs(); logModal.classList.add("hidden");
},300);

aiToggle.onchange=async()=>{
  if(aiToggle.checked && !generator){
    if(!navigator.onLine){alert("‚ö†Ô∏è Offline. AI Coach requires internet.");aiToggle.checked=false;return;}
    spinner.classList.remove("hidden");
    const timeout=(p,ms)=>Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),ms))]);
    try{
      const {pipeline}=await import("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0");
      generator=await timeout(pipeline("text-generation","Xenova/distilgpt2",{
        progress_callback:(prog)=>{if(prog.total){const pct=Math.floor((prog.loaded/prog.total)*100);spinnerText.textContent=`Downloading AI Coach‚Ä¶ ${pct}% (~66MB)`;progressBar.style.width=pct+"%";}}
      }),30000);
      spinnerText.textContent="AI Coach ready (cached for next time)";
    }catch(e){
      alert("‚ö†Ô∏è "+(e.message||"Failed to load AI Coach.")); aiToggle.checked=false;
    }
    spinner.classList.add("hidden");
  }
};

renderActivities(); renderLogs();
</script>
</body>
</html>
