<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Daily Activity Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center shadow-md">
    <span class="text-lg md:text-xl font-bold">AI Daily Activity Tracker ü§ñ</span>
    <div class="flex items-center space-x-2">
      <label class="flex items-center space-x-1 text-sm">
        <input type="checkbox" id="aiToggle" class="w-4 h-4">
        <span>AI Coach</span>
      </label>
    </div>
  </header>

  <!-- Spinner Overlay -->
  <div id="spinner" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center space-y-4 z-50">
    <div class="w-12 h-12 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
    <p id="spinnerText" class="text-lg font-semibold text-blue-300">Preparing AI Coach‚Ä¶</p>
    <div class="w-64 bg-gray-700 rounded-full h-4 overflow-hidden">
      <div id="progressBar" class="bg-blue-400 h-4 w-0"></div>
    </div>
    <p class="text-sm text-gray-400">Model size: ~66 MB (cached after first load)</p>
  </div>

  <!-- Logs -->
  <main id="log" class="flex-1 overflow-y-auto p-2 md:p-4 space-y-2"></main>

  <!-- Floating Buttons -->
  <button id="fabBtn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-500 text-white rounded-full w-16 h-16 flex items-center justify-center text-3xl shadow-lg">‚ûï</button>
  <button id="clearBtn" class="fixed bottom-28 right-6 bg-red-600 px-4 py-2 rounded-lg shadow-lg text-sm font-semibold hover:bg-red-500">üóëÔ∏è Clear</button>
  <button id="manageBtn" class="fixed bottom-48 right-6 bg-green-600 px-4 py-2 rounded-lg shadow-lg text-sm font-semibold hover:bg-green-500">‚öôÔ∏è Manage</button>

  <!-- Log Modal -->
  <div id="logModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md shadow-xl">
      <h2 class="text-lg font-bold mb-4">Log Activity</h2>
      <div class="flex flex-col space-y-2 md:flex-row md:space-x-2 mb-4">
        <select id="activity" class="flex-1 p-3 rounded bg-gray-700 text-white border border-gray-500"></select>
        <button id="logBtn" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold">Log</button>
      </div>
      <div class="text-right">
        <button id="closeLogModal" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Close</button>
      </div>
    </div>
  </div>

  <!-- Manage Activities Modal -->
  <div id="manageModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md shadow-xl">
      <h2 class="text-lg font-bold mb-4">Manage Activities</h2>
      <div class="flex space-x-2 mb-4">
        <input id="newActivity" type="text" placeholder="New activity..." class="flex-1 p-2 rounded bg-gray-700 border border-gray-500 text-white">
        <button id="addActivityBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded">Add</button>
      </div>
      <ul id="activityList" class="space-y-2"></ul>
      <div class="text-right mt-4">
        <button id="closeManageModal" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    let generator = null;
    const spinner = document.getElementById("spinner");
    const spinnerText = document.getElementById("spinnerText");
    const progressBar = document.getElementById("progressBar");
    const aiToggle = document.getElementById("aiToggle");

    // Activities
    let activities = JSON.parse(localStorage.getItem("activityList")) || [
      "Sleeping","Eating","Drinking","Personal Hygiene","Working / Studying",
      "Social Interaction","Walking / Moving","Leisure / Entertainment","Resting / Relaxing","Using Technology"
    ];
    let logs = JSON.parse(localStorage.getItem("activityLogs") || "[]");

    const activitySelect = document.getElementById("activity");
    const logDiv = document.getElementById("log");
    const logBtn = document.getElementById("logBtn");
    const fabBtn = document.getElementById("fabBtn");
    const logModal = document.getElementById("logModal");
    const closeLogModal = document.getElementById("closeLogModal");
    const clearBtn = document.getElementById("clearBtn");
    const manageBtn = document.getElementById("manageBtn");
    const manageModal = document.getElementById("manageModal");
    const closeManageModal = document.getElementById("closeManageModal");
    const addActivityBtn = document.getElementById("addActivityBtn");
    const newActivityInput = document.getElementById("newActivity");
    const activityListUI = document.getElementById("activityList");

    // Fallback feedback
    function ruleFeedback(activity) {
      const templates = [
        `üî• Great job staying consistent with ${activity}!`,
        `üåü You're doing amazing by focusing on ${activity}!`,
        `üí™ Keep up the good work on ${activity}!`,
        `‚ú® Consistency in ${activity} will pay off!`,
        `üöÄ Every step in ${activity} counts!`
      ];
      return templates[Math.floor(Math.random()*templates.length)];
    }

    async function aiCoachFeedback(activity) {
      if (!generator) return ruleFeedback(activity);
      const prompt = `I just did the activity: ${activity}. As a motivational life coach, give me up to 4 short positive sentences encouraging me. Mention "${activity}" clearly at least once.`;
      try {
        const output = await generator(prompt, {
          max_new_tokens: 100,
          temperature: 0.8,
          do_sample: true
        });
        let text = output[0].generated_text;
        if (text.startsWith(prompt)) {
          text = text.slice(prompt.length).trim();
        }
        if (!text.toLowerCase().includes(activity.toLowerCase())) {
          text = ruleFeedback(activity);
        }
        return text || ruleFeedback(activity);
      } catch {
        return `‚ö†Ô∏è AI Coach unavailable. ${ruleFeedback(activity)}`;
      }
    }

    function renderActivities() {
      activitySelect.innerHTML = "";
      activities.forEach(a => {
        const opt = document.createElement("option");
        opt.textContent = a;
        activitySelect.appendChild(opt);
      });
      renderActivityManager();
    }

    function renderLogs() {
      logDiv.innerHTML = "";
      logs.forEach((e,i) => {
        const row = document.createElement("div");
        row.className = "flex flex-col bg-gray-700 p-3 rounded space-y-2 shadow";
        let borderColor = "border-green-400";
        let titleColor = "text-green-400";
        if (e.feedback.startsWith("‚ö†Ô∏è")) {
          borderColor = "border-red-400";
          titleColor = "text-red-400";
        } else if (e.status === "thinking") {
          borderColor = "border-yellow-400 animate-pulse";
          titleColor = "text-yellow-400";
        }
        row.innerHTML = `
          <div class="flex justify-between items-center">
            <span>üìù ${e.time} ‚Üí <b>${e.activity}</b></span>
            <button class="delete-log bg-red-500 px-2 rounded text-xs" data-index="${i}">‚úï</button>
          </div>
          <div class="bg-gray-800 p-2 rounded border-l-4 ${borderColor}">
            <p class="font-semibold mb-1 ${titleColor}">ü§ñ AI Coach says:</p>
            <p class="text-sm text-gray-200 leading-snug">${e.feedback}</p>
          </div>
        `;
        logDiv.appendChild(row);
      });
      document.querySelectorAll(".delete-log").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const idx = e.target.getAttribute("data-index");
          logs.splice(idx,1);
          localStorage.setItem("activityLogs",JSON.stringify(logs));
          renderLogs();
        });
      });
    }

    function renderActivityManager() {
      activityListUI.innerHTML = "";
      activities.forEach((a,i)=>{
        const li = document.createElement("li");
        li.className = "flex justify-between bg-gray-700 p-2 rounded";
        li.innerHTML = `
          <span>${a}</span>
          <button class="delete-activity bg-red-500 px-2 rounded text-xs" data-index="${i}">‚úï</button>
        `;
        activityListUI.appendChild(li);
      });
      document.querySelectorAll(".delete-activity").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const idx = e.target.getAttribute("data-index");
          activities.splice(idx,1);
          localStorage.setItem("activityList",JSON.stringify(activities));
          renderActivities();
        });
      });
    }

    // üöÄ Log with persistent "thinking" banner
    logBtn.addEventListener("click", async ()=>{
      const act = activitySelect.value;

      // Insert yellow thinking entry
      const entry = {
        activity: act,
        time: new Date().toLocaleString(),
        feedback: "ü§ñ AI Coach is thinking...",
        status: "thinking"
      };
      logs.push(entry);
      localStorage.setItem("activityLogs", JSON.stringify(logs));
      renderLogs();

      const idx = logs.length - 1;
      const logRow = document.querySelectorAll("#log > div")[idx];
      const feedbackBox = logRow.querySelector("p.text-sm");
      const feedbackTitle = logRow.querySelector("p.font-semibold");
      const feedbackContainer = logRow.querySelector("div.bg-gray-800");

      if (aiToggle.checked && generator) {
        try {
          const feedback = await aiCoachFeedback(act);
          logs[idx].feedback = feedback;
          logs[idx].status = "done";
          feedbackTitle.classList.remove("text-yellow-400");
          feedbackTitle.classList.add("text-green-400");
          feedbackBox.textContent = feedback;
          feedbackContainer.className = "bg-gray-800 p-2 rounded border-l-4 border-green-400";
        } catch {
          logs[idx].feedback = `‚ö†Ô∏è AI Coach unavailable. ${ruleFeedback(act)}`;
          logs[idx].status = "fail";
          feedbackTitle.classList.remove("text-yellow-400");
          feedbackTitle.classList.add("text-red-400");
          feedbackBox.textContent = logs[idx].feedback;
          feedbackContainer.className = "bg-gray-800 p-2 rounded border-l-4 border-red-400";
        }
      } else if (aiToggle.checked && !generator) {
        logs[idx].feedback = `‚ö†Ô∏è AI Coach unavailable (offline or not loaded). ${ruleFeedback(act)}`;
        logs[idx].status = "fail";
        feedbackTitle.classList.remove("text-yellow-400");
        feedbackTitle.classList.add("text-red-400");
        feedbackBox.textContent = logs[idx].feedback;
        feedbackContainer.className = "bg-gray-800 p-2 rounded border-l-4 border-red-400";
      } else {
        logs[idx].feedback = ruleFeedback(act);
        logs[idx].status = "done";
        feedbackTitle.classList.remove("text-yellow-400");
        feedbackTitle.classList.add("text-green-400");
        feedbackBox.textContent = logs[idx].feedback;
        feedbackContainer.className = "bg-gray-800 p-2 rounded border-l-4 border-green-400";
      }

      localStorage.setItem("activityLogs", JSON.stringify(logs));
      logModal.classList.add("hidden");
    });

    // UI Buttons
    fabBtn.addEventListener("click", ()=>logModal.classList.remove("hidden"));
    closeLogModal.addEventListener("click", ()=>logModal.classList.add("hidden"));
    clearBtn.addEventListener("click", ()=>{if(confirm("Delete all logs?")){logs=[];localStorage.setItem("activityLogs","[]");renderLogs();}});
    manageBtn.addEventListener("click", ()=>manageModal.classList.remove("hidden"));
    closeManageModal.addEventListener("click", ()=>manageModal.classList.add("hidden"));
    addActivityBtn.addEventListener("click", ()=>{
      const val = newActivityInput.value.trim();
      if(val && !activities.includes(val)){
        activities.push(val);
        localStorage.setItem("activityList",JSON.stringify(activities));
        renderActivities();
        newActivityInput.value="";
      }
    });

    aiToggle.addEventListener("change", async ()=>{
      if (aiToggle.checked && !generator) {
        if (!navigator.onLine) {
          alert("‚ö†Ô∏è You are offline. AI Coach cannot be loaded.");
          aiToggle.checked = false;
          return;
        }
        spinner.classList.remove("hidden");
        try {
          const { pipeline } = await import("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0");
          generator = await pipeline("text-generation","Xenova/distilgpt2",{
            progress_callback: (progress)=>{
              if(progress && progress.total){
                const percent = Math.floor((progress.loaded/progress.total)*100);
                spinnerText.textContent = `Downloading AI Coach‚Ä¶ ${percent}%`;
                progressBar.style.width = percent + "%";
              }
            }
          });
        } catch(e) {
          alert("‚ö†Ô∏è Failed to load AI Coach. Falling back to basic encouragement.");
          aiToggle.checked = false;
        }
        spinner.classList.add("hidden");
      }
    });

    renderActivities();
    renderLogs();
  </script>
</body>
</html>
