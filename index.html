<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI Daily Activity Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">

  <!-- Header -->
  <header class="p-4 bg-gray-800 text-center text-xl font-bold">
    AI Daily Activity Tracker
  </header>

  <!-- Main Content -->
  <main class="flex-1 p-4 overflow-y-auto" id="log" aria-live="polite"></main>

  <!-- Floating Buttons -->
  <div class="fixed bottom-20 right-4 space-y-3">
    <button id="fabBtn" aria-label="Log activity"
      class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full shadow-lg text-2xl">‚ûï</button>
    <button id="clearBtn" aria-label="Clear logs"
      class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-full shadow-lg">üóëÔ∏è</button>
    <button id="manageBtn" aria-label="Manage activities"
      class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg">‚öôÔ∏è</button>
  </div>

  <!-- Footer -->
  <footer class="p-2 text-xs text-gray-500 fixed bottom-0 left-0">Testversion 0.19</footer>

  <!-- Log Modal -->
  <div id="logModal" role="dialog" aria-labelledby="logTitle"
    class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-80">
      <h2 id="logTitle" class="text-lg font-bold mb-4">Log Activity</h2>
      <select id="activitySelect" class="w-full p-2 rounded bg-gray-700 mb-4"></select>
      <label class="flex items-center space-x-2 mb-4">
        <input type="checkbox" id="aiToggle" class="form-checkbox">
        <span>Enable AI Coach</span>
      </label>
      <div class="flex justify-end space-x-2">
        <button id="cancelLog" class="px-4 py-2 bg-gray-600 rounded">Cancel</button>
        <button id="logBtn" class="px-4 py-2 bg-blue-600 rounded">Log</button>
      </div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div id="manageModal" role="dialog" aria-labelledby="manageTitle"
    class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-96">
      <h2 id="manageTitle" class="text-lg font-bold mb-4">Manage Activities</h2>
      <ul id="activityList" class="mb-4"></ul>
      <input id="newActivityInput" placeholder="New activity"
        class="w-full p-2 rounded bg-gray-700 mb-2" />
      <button id="addActivityBtn" class="w-full py-2 bg-green-600 rounded">Add Activity</button>
      <div class="flex justify-end mt-4">
        <button id="closeManage" class="px-4 py-2 bg-gray-600 rounded">Close</button>
      </div>
    </div>
  </div>

  <!-- Spinner -->
  <div id="spinner" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center space-y-4 z-50">
    <div class="w-12 h-12 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
    <p id="spinnerText" class="text-lg font-semibold text-blue-300">Downloading AI Coach (~66 MB)‚Ä¶</p>
    <div class="w-48 bg-gray-700 rounded">
      <div id="progressBar" class="h-2 bg-blue-400 w-0 rounded"></div>
    </div>
    <p class="text-sm text-gray-400">First load only. Cached afterward.</p>
  </div>

  <script type="module">
    const log = document.getElementById("log");
    const logModal = document.getElementById("logModal");
    const manageModal = document.getElementById("manageModal");
    const activitySelect = document.getElementById("activitySelect");
    const aiToggle = document.getElementById("aiToggle");
    const logBtn = document.getElementById("logBtn");
    const cancelLog = document.getElementById("cancelLog");
    const clearBtn = document.getElementById("clearBtn");
    const fabBtn = document.getElementById("fabBtn");
    const manageBtn = document.getElementById("manageBtn");
    const closeManage = document.getElementById("closeManage");
    const activityList = document.getElementById("activityList");
    const newActivityInput = document.getElementById("newActivityInput");
    const addActivityBtn = document.getElementById("addActivityBtn");
    const spinner = document.getElementById("spinner");
    const spinnerText = document.getElementById("spinnerText");
    const progressBar = document.getElementById("progressBar");

    let activities = JSON.parse(localStorage.getItem("activityList")) || 
      ["Eat","Sleep","Work","Exercise","Study","Commute","Socialize","Relax","Shop","Cook"];
    let logs = JSON.parse(localStorage.getItem("activityLogs")) || [];
    let generator = null;

    function safeSetItem(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); }
      catch { alert("‚ö†Ô∏è Storage full. Data may not save."); }
    }

    function sanitize(str) {
      return str.replace(/[<>"'&]/g, c => ({"<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#x27;","&":"&amp;"}[c]));
    }

    function renderActivities() {
      activitySelect.innerHTML = "";
      activities.forEach(a => {
        const opt = document.createElement("option");
        opt.textContent = a;
        opt.value = a;
        activitySelect.appendChild(opt);
      });
      activityList.innerHTML = "";
      activities.forEach((a,i) => {
        const li = document.createElement("li");
        li.className = "flex justify-between items-center bg-gray-700 p-2 rounded mb-1";
        li.innerHTML = `<span>${a}</span><button class="text-red-400" data-i="${i}">‚ùå</button>`;
        li.querySelector("button").onclick = () => {
          activities.splice(i,1);
          safeSetItem("activityList",activities);
          renderActivities();
        };
        activityList.appendChild(li);
      });
    }

    function renderLogs() {
      log.innerHTML = "";
      logs.forEach(l => {
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-2 rounded border-l-4 mb-2 " +
          (l.status==="thinking"?"border-yellow-400":
           l.status==="done"?"border-green-400":"border-red-400");
        div.innerHTML = `<p class="font-semibold ${l.status==="thinking"?"text-yellow-400":l.status==="done"?"text-green-400":"text-red-400"}">
          ${l.activity} ‚Äî ${l.time}</p><p class="text-sm">${l.feedback}</p>`;
        log.appendChild(div);
      });
    }

    renderActivities();
    renderLogs();

    fabBtn.onclick = () => logModal.classList.remove("hidden");
    cancelLog.onclick = () => logModal.classList.add("hidden");
    manageBtn.onclick = () => manageModal.classList.remove("hidden");
    closeManage.onclick = () => manageModal.classList.add("hidden");
    clearBtn.onclick = () => { if(confirm("Clear all logs?")){ logs=[]; safeSetItem("activityLogs",logs); renderLogs(); } };
    addActivityBtn.onclick = () => {
      const val = sanitize(newActivityInput.value.trim());
      if(!val){ alert("Enter activity."); return; }
      if(activities.includes(val)){ alert("Exists already."); return; }
      activities.push(val);
      safeSetItem("activityList",activities);
      renderActivities();
      newActivityInput.value="";
    };

    function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

    logBtn.onclick = debounce(async ()=>{
      const act = activitySelect.value;
      const entry = { activity: act, time: new Date().toLocaleString(), feedback:"ü§ñ AI Coach is thinking...", status:"thinking" };
      logs.push(entry); safeSetItem("activityLogs",logs); renderLogs();
      const idx = logs.length-1;

      if(aiToggle.checked && generator){
        try {
          const feedback = await aiCoachFeedback(act);
          logs[idx].feedback = feedback;
          logs[idx].status = "done";
        } catch {
          logs[idx].feedback = "‚ö†Ô∏è AI Coach error. " + ruleFeedback(act);
          logs[idx].status = "fail";
        }
      } else if(aiToggle.checked && !generator) {
        logs[idx].feedback = "‚ö†Ô∏è AI Coach unavailable. " + ruleFeedback(act);
        logs[idx].status = "fail";
      } else {
        logs[idx].feedback = ruleFeedback(act);
        logs[idx].status = "done";
      }
      safeSetItem("activityLogs",logs); renderLogs();
      logModal.classList.add("hidden");
    },300);

    function ruleFeedback(a){
      const fb = {
        "Eat":"Good fuel for your body! üçé",
        "Sleep":"Rest well, recharge! üò¥",
        "Work":"Stay focused, you're moving forward! üíª",
        "Exercise":"Great energy boost! üèãÔ∏è",
        "Study":"Keep learning, it pays off! üìö",
        "Commute":"Time well spent reaching your goals. üöá",
        "Socialize":"Connections make life rich. ü§ù",
        "Relax":"Balance is key. üåø",
        "Shop":"Take what you need, stay mindful. üõí",
        "Cook":"Home-made energy, nice! üç≥"
      };
      return fb[a]||"Keep it up!";
    }

    async function aiCoachFeedback(act){
      const out = await generator(act,{max_new_tokens:50});
      let txt = out[0].generated_text;
      if(txt.startsWith(act)) txt = txt.slice(act.length);
      return txt.trim();
    }

    aiToggle.onchange = async ()=>{
      if(aiToggle.checked && !generator){
        if(!navigator.onLine){ alert("‚ö†Ô∏è Offline. AI Coach needs internet."); aiToggle.checked=false; return; }
        spinner.classList.remove("hidden"); spinnerText.textContent="Downloading AI Coach (~66MB)..."; progressBar.style.width="0%";
        try {
          const { pipeline } = await import("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0");
          generator = await pipeline("text-generation","Xenova/distilgpt2",{
            progress_callback:(p)=>{ if(p.total){ const pct=Math.floor(p.loaded/p.total*100); progressBar.style.width=pct+"%"; spinnerText.textContent=`Downloading AI Coach‚Ä¶ ${pct}% (~66MB)`; } }
          });
          spinnerText.textContent="‚úÖ AI Coach ready (cached)";
        } catch(e){ console.error("AI load fail:",e); alert("‚ö†Ô∏è Failed to load AI Coach."); aiToggle.checked=false; }
        spinner.classList.add("hidden");
      }
    };
  </script>
</body>
</html>
